name: CI/CD Pipeline - Multi-ECS HA Deployment

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  packages: read

jobs:
  ci:
    runs-on: ubuntu-latest
    env:
      GITHUB_ACTOR: ${{ github.actor }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v3
      - name: Set up JDK 11
        uses: actions/setup-java@v3
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: maven
      - name: Build with Maven
        run: mvn -B package --file pom.xml -DskipTests -Dmaven.test.skip=true -Dmaven.javadoc.skip=true

  docker:
    needs: ci
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.short_sha.outputs.sha_short }}
    steps:
      - uses: actions/checkout@v3
      - name: Get full SHA
        id: short_sha
        run: echo "sha_short=${{ github.sha }}" >> $GITHUB_OUTPUT
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      - name: Login to ACR
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.ACR_REGISTRY }}
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}
      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ${{ secrets.ACR_REGISTRY }}/${{ secrets.ACR_NAMESPACE }}/goodface-user
          tags: |
            type=raw,value=${{ github.sha }}
            type=raw,value=latest
      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          build-args: |
            GITHUB_ACTOR=${{ github.actor }}
            GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  deploy-ecs1:
    needs: docker
    if: needs.docker.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Copy docker-compose to ECS-1
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ECS_HOST_1 }}
          username: ${{ secrets.ECS_USER }}
          port: ${{ secrets.ECS_PORT }}
          key: ${{ secrets.ECS_SSH_KEY }}
          source: "deploy/docker-compose.yml"
          target: "/opt/goodface-user/"
          strip_components: 1
          overwrite: true

      - name: Deploy to ECS-1 (47.99.32.144)
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.ECS_HOST_1 }}
          username: ${{ secrets.ECS_USER }}
          port: ${{ secrets.ECS_PORT }}
          key: ${{ secrets.ECS_SSH_KEY }}
          script: |
            set -e
            mkdir -p /opt/goodface-user
            cd /opt/goodface-user

            docker login ${{ secrets.ACR_REGISTRY }} -u '${{ secrets.ACR_USERNAME }}' -p '${{ secrets.ACR_PASSWORD }}'

            # Generate .env from GitHub Secrets
            echo "ACR_REGISTRY=${{ secrets.ACR_REGISTRY }}" > .env
            echo "ACR_NAMESPACE=${{ secrets.ACR_NAMESPACE }}" >> .env
            echo "IMAGE_TAG=${{ github.sha }}" >> .env
            echo "SPRING_PROFILES_ACTIVE=prod" >> .env
            echo "SPRING_DATASOURCE_URL=${{ secrets.SPRING_DATASOURCE_URL }}" >> .env
            echo "SPRING_DATASOURCE_USERNAME=${{ secrets.SPRING_DATASOURCE_USERNAME }}" >> .env
            echo "SPRING_DATASOURCE_PASSWORD=${{ secrets.SPRING_DATASOURCE_PASSWORD }}" >> .env
            echo "SPRING_REDIS_HOST=${{ secrets.SPRING_REDIS_HOST }}" >> .env
            echo "SPRING_REDIS_PORT=${{ secrets.SPRING_REDIS_PORT }}" >> .env
            echo "SPRING_REDIS_PASSWORD=${{ secrets.SPRING_REDIS_PASSWORD }}" >> .env
            echo "DUBBO_REGISTRY_ADDRESS=${{ secrets.DUBBO_REGISTRY_ADDRESS }}" >> .env
            echo "DUBBO_REGISTRY_NAMESPACE=${{ secrets.DUBBO_REGISTRY_NAMESPACE }}" >> .env
            echo "NACOS_USERNAME=${{ secrets.NACOS_USERNAME }}" >> .env
            echo "NACOS_PASSWORD=${{ secrets.NACOS_PASSWORD }}" >> .env

            # Try to pull the specific image tag, fallback to latest if not found
            if ! docker compose --env-file .env pull; then
              echo "⚠️  Failed to pull image ${{ github.sha }}, falling back to latest"
              sed -i 's/IMAGE_TAG=.*/IMAGE_TAG=latest/' .env
              docker compose --env-file .env pull
            fi
            docker compose --env-file .env up -d --remove-orphans

            docker network create goodface-net || true
            docker network connect goodface-net goodface-user || true

            echo "✅ ECS-1 deployment completed"

  deploy-ecs2:
    needs: docker
    if: needs.docker.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Copy docker-compose to ECS-2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ECS_HOST_2 }}
          username: ${{ secrets.ECS_USER }}
          port: ${{ secrets.ECS_PORT }}
          key: ${{ secrets.ECS_SSH_KEY_2 }}
          source: "deploy/docker-compose.yml"
          target: "/opt/goodface-user/"
          strip_components: 1
          overwrite: true
          timeout: 300s
          command_timeout: 60s
          debug: true

      - name: Deploy to ECS-2 (47.114.90.156)
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.ECS_HOST_2 }}
          username: ${{ secrets.ECS_USER }}
          port: ${{ secrets.ECS_PORT }}
          key: ${{ secrets.ECS_SSH_KEY_2 }}
          timeout: 300s
          command_timeout: 300s
          debug: true
          script: |
            set -e
            mkdir -p /opt/goodface-user
            cd /opt/goodface-user

            docker login ${{ secrets.ACR_REGISTRY }} -u '${{ secrets.ACR_USERNAME }}' -p '${{ secrets.ACR_PASSWORD }}'

            # Generate .env from GitHub Secrets
            echo "ACR_REGISTRY=${{ secrets.ACR_REGISTRY }}" > .env
            echo "ACR_NAMESPACE=${{ secrets.ACR_NAMESPACE }}" >> .env
            echo "IMAGE_TAG=${{ github.sha }}" >> .env
            echo "SPRING_PROFILES_ACTIVE=prod" >> .env
            echo "SPRING_DATASOURCE_URL=${{ secrets.SPRING_DATASOURCE_URL }}" >> .env
            echo "SPRING_DATASOURCE_USERNAME=${{ secrets.SPRING_DATASOURCE_USERNAME }}" >> .env
            echo "SPRING_DATASOURCE_PASSWORD=${{ secrets.SPRING_DATASOURCE_PASSWORD }}" >> .env
            echo "SPRING_REDIS_HOST=${{ secrets.SPRING_REDIS_HOST }}" >> .env
            echo "SPRING_REDIS_PORT=${{ secrets.SPRING_REDIS_PORT }}" >> .env
            echo "SPRING_REDIS_PASSWORD=${{ secrets.SPRING_REDIS_PASSWORD }}" >> .env
            echo "DUBBO_REGISTRY_ADDRESS=${{ secrets.DUBBO_REGISTRY_ADDRESS }}" >> .env
            echo "DUBBO_REGISTRY_NAMESPACE=${{ secrets.DUBBO_REGISTRY_NAMESPACE }}" >> .env
            echo "NACOS_USERNAME=${{ secrets.NACOS_USERNAME }}" >> .env
            echo "NACOS_PASSWORD=${{ secrets.NACOS_PASSWORD }}" >> .env

            # Try to pull the specific image tag, fallback to latest if not found
            if ! docker compose --env-file .env pull; then
              echo "⚠️  Failed to pull image ${{ github.sha }}, falling back to latest"
              echo "IMAGE_TAG=latest" > .env
              docker compose --env-file .env pull
            fi
            docker compose --env-file .env up -d --remove-orphans

            docker network create goodface-net || true
            docker network connect goodface-net goodface-user || true

            echo "✅ ECS-2 deployment completed"

  health-check:
    needs: [deploy-ecs1, deploy-ecs2]
    runs-on: ubuntu-latest
    steps:
      - name: Health Check ECS-1
        run: |
          sleep 30
          curl -f http://${{ secrets.ECS_HOST_1 }}:8002/actuator/health || echo "⚠️  ECS-1 health check failed"
      - name: Health Check ECS-2
        run: |
          sleep 30
          curl -f http://${{ secrets.ECS_HOST_2 }}:8002/actuator/health || echo "⚠️  ECS-2 health check failed"
